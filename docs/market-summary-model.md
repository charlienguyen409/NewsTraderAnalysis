# MarketSummary Database Model Documentation

## Overview

The `MarketSummary` model provides persistent storage for market summaries generated during analysis sessions. Each summary captures comprehensive market insights generated by LLM analysis of financial news articles and trading positions.

## Database Model Structure

### Table: `market_summaries`

#### Fields

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| `id` | UUID | Primary key, auto-generated | Primary Key, NOT NULL |
| `session_id` | UUID | Links to analysis session | NOT NULL, Indexed |
| `summary_data` | JSONB | Complete LLM-generated summary | NOT NULL |
| `generated_at` | TIMESTAMP | Creation timestamp | NOT NULL, Default: now() |
| `analysis_type` | ENUM | Type: 'full' or 'headlines' | NOT NULL |
| `model_used` | VARCHAR | LLM model identifier | NOT NULL |
| `data_sources` | JSONB | Source data counts/metadata | Default: {} |

#### Indexes

- `ix_market_summaries_session_generated`: Composite index on (`session_id`, `generated_at`)
- `ix_market_summaries_analysis_type_generated`: Composite index on (`analysis_type`, `generated_at`)
- `ix_market_summaries_model_generated`: Composite index on (`model_used`, `generated_at`)

#### Analysis Type Enum

```python
class AnalysisTypeEnum(PyEnum):
    FULL = "full"          # Complete content analysis
    HEADLINES = "headlines" # Headlines-only analysis
```

## Pydantic Schemas

### MarketSummaryCreate

Used for creating new market summaries:

```python
{
    "session_id": "uuid4-string",
    "summary_data": {
        "market_overview": "...",
        "key_themes": [...],
        "sector_performance": {...},
        "notable_events": [...],
        "trading_opportunities": [...]
    },
    "analysis_type": "full" | "headlines",
    "model_used": "gpt-4" | "claude-3-sonnet",
    "data_sources": {
        "articles_count": 25,
        "analyses_count": 25,
        "positions_count": 8
    }
}
```

### MarketSummaryResponse

Full response schema for API endpoints:

```python
{
    "id": "uuid4-string",
    "session_id": "uuid4-string",
    "generated_at": "2024-01-15T10:30:00Z",
    "summary_data": { ... },  # Complete summary data
    "analysis_type": "full",
    "model_used": "gpt-4",
    "data_sources": { ... }
}
```

### MarketSummaryListItem

Lightweight schema for listing operations:

```python
{
    "id": "uuid4-string",
    "session_id": "uuid4-string",
    "generated_at": "2024-01-15T10:30:00Z",
    "analysis_type": "full",
    "model_used": "gpt-4",
    "article_count": 25,
    "position_count": 8
}
```

## Summary Data Structure

The `summary_data` JSONB field contains the complete LLM-generated market summary. Typical structure:

```json
{
    "market_overview": "Overall market sentiment and key themes",
    "key_themes": [
        {
            "theme": "Tech Earnings",
            "sentiment": "positive",
            "relevant_tickers": ["AAPL", "MSFT"]
        }
    ],
    "sector_performance": {
        "technology": {
            "sentiment": "positive",
            "key_drivers": ["Strong earnings", "AI adoption"]
        }
    },
    "notable_events": [
        {
            "event": "Fed rate decision",
            "impact": "Market volatility expected"
        }
    ],
    "trading_opportunities": [
        {
            "opportunity": "Tech sector momentum",
            "tickers": ["AAPL", "MSFT"],
            "rationale": "Strong earnings momentum"
        }
    ],
    "risk_factors": [
        "Geopolitical tensions",
        "Interest rate uncertainty"
    ]
}
```

## Data Sources Structure

The `data_sources` JSONB field tracks the source material used for summary generation:

```json
{
    "articles_count": 25,
    "analyses_count": 25,
    "positions_count": 8,
    "sources_breakdown": {
        "finviz": 15,
        "biztoc": 10
    },
    "analysis_duration_seconds": 45.7
}
```

## Relationships and Integration

### Integration with Existing Models

- **session_id**: Links to analysis sessions tracked in `ActivityLog.session_id`
- **No direct foreign keys**: Uses UUID references to maintain loose coupling
- **Temporal relationship**: One market summary per analysis session

### Usage in Analysis Pipeline

1. Market summary generated at end of analysis session
2. Summary data stored with session context
3. Analysis type matches the type of analysis performed
4. Data sources reflect actual counts from the session

## Query Examples

### Get Latest Summary by Session

```sql
SELECT * FROM market_summaries 
WHERE session_id = 'session-uuid'
ORDER BY generated_at DESC 
LIMIT 1;
```

### Get Recent Full Analysis Summaries

```sql
SELECT * FROM market_summaries 
WHERE analysis_type = 'full'
AND generated_at >= NOW() - INTERVAL '7 days'
ORDER BY generated_at DESC;
```

### Get Summary Statistics by Model

```sql
SELECT 
    model_used,
    analysis_type,
    COUNT(*) as summary_count,
    AVG((data_sources->>'articles_count')::int) as avg_articles
FROM market_summaries 
GROUP BY model_used, analysis_type;
```

## Performance Considerations

- **Indexes**: Optimized for session-based lookups and chronological queries
- **JSONB**: Efficient storage and querying of nested summary data
- **Partitioning**: Consider partitioning by date for high-volume deployments

## Future Extensions

- **Version tracking**: Add version field for summary regeneration
- **Quality metrics**: Add fields for summary quality scores
- **Export formats**: Add fields to track export formats (PDF, email, etc.)